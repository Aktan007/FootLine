{% extends 'shop/base.html' %}
{% block title %}Товары - FootLine{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="fw-bold"><i class="bi bi-box-seam me-2"></i>Каталог товаров</h1>
    <a href="{% url 'shop:dashboard' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-1"></i>Назад
    </a>
</div>

{% if has_filters %}
<div class="card mb-4 p-3">
    <form method="get" id="filterForm">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label fw-semibold">Поиск</label>
                <input type="text" name="search" class="form-control"
                       placeholder="Название, артикул..."
                       value="{{ search_query }}" onchange="filterForm.submit()">
            </div>
            <div class="col-md-4">
                <label class="form-label fw-semibold">Поставщик</label>
                <select name="supplier" class="form-select" onchange="filterForm.submit()">
                    <option value="">Все поставщики</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}"
                            {% if supplier.id|stringformat:"s" == selected_supplier %}selected{% endif %}>
                        {{ supplier.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-semibold">Сортировка по кол-ву</label>
                <select name="sort_quantity" class="form-select" onchange="filterForm.submit()">
                    <option value="">По умолчанию</option>
                    <option value="asc" {% if sort_quantity == 'asc' %}selected{% endif %}>По возрастанию</option>
                    <option value="desc" {% if sort_quantity == 'desc' %}selected{% endif %}>По убыванию</option>
                </select>
            </div>
        </div>
    </form>
</div>
{% endif %}

{% if user.profile.role == 'admin' %}
<div class="mb-3">
    <a href="{% url 'shop:add_product' %}" class="btn btn-primary">
        <i class="bi bi-plus-lg me-1"></i>Добавить товар
    </a>
</div>
{% endif %}

{% if products %}
<div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
        <tbody>
            {% for product in products %}
            <tr class="{% if product.quantity == 0 %}empty-stock{% elif product.discount > 15 %}high-discount{% endif %}">
                <td class="text-center" style="width:90px">
                    {% if product.photo %}
                        <img src="{{ product.photo.url }}" alt="{{ product.name }}"
                             style="max-width:80px;max-height:60px;object-fit:cover;border-radius:4px;">
                    {% else %}
                        <span class="text-muted small">Нет фото</span>
                    {% endif %}
                </td>
                <td><strong>{{ product.article }}</strong></td>
                <td>{{ product.name }}</td>
                <td>{{ product.category.name }}</td>
                <td>{{ product.manufacturer.name }}</td>
                <td>{{ product.supplier.name }}</td>
                <td>
                    {% if product.discount > 0 %}
                        <span class="price-original">{{ product.price }} &#8381;</span><br>
                        <span class="price-final">{{ product.get_final_price }} &#8381;</span>
                    {% else %}
                        {{ product.price }} &#8381;
                    {% endif %}
                </td>
                <td>
                    {% if product.quantity == 0 %}
                        <span class="badge bg-danger">Нет в наличии</span>
                    {% else %}
                        {{ product.quantity }} {{ product.unit }}
                    {% endif %}
                </td>
                <td>
                    {% if product.discount > 0 %}
                        <span class="badge bg-warning text-dark">-{{ product.discount }}%</span>
                    {% else %}—{% endif %}
                </td>
                {% if user.profile.role == 'admin' %}
                <td>
                    <div class="d-flex gap-1">
                        <a href="{% url 'shop:edit_product' product.article %}" class="btn btn-primary btn-sm">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'shop:delete_product' product.article %}" class="btn btn-danger btn-sm">
                            <i class="bi bi-trash"></i>
                        </a>
                    </div>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<p class="text-muted">Всего товаров: <strong>{{ products|length }}</strong></p>
{% else %}
<div class="text-center py-5 text-muted">
    <i class="bi bi-search" style="font-size:3rem"></i>
    <p class="mt-3 fs-5">По вашему запросу товаров не найдено</p>
</div>
{% endif %}
{% endblock %}
